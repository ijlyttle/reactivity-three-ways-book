<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3.2 Demonstration app | Data-Science Reactivity: Three Ways</title>
  <meta name="description" content="3.2 Demonstration app | Data-Science Reactivity: Three Ways" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="3.2 Demonstration app | Data-Science Reactivity: Three Ways" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3.2 Demonstration app | Data-Science Reactivity: Three Ways" />
  
  
  

<meta name="author" content="Ian Lyttle" />


<meta name="date" content="2022-04-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="principles-2.html"/>
<link rel="next" href="stray-thoughts.html"/>
<script src="libs/header-attrs-2.11.3/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script>
  // wait for the DOM to finish loading, then run function
  window.addEventListener('DOMContentLoaded', (event) => {

    // we want to set some element styles according to the class of the book
    //   - the theme of the book depends on class including:
    //       color-theme-1: means sepia
    //       color-theme-2: means night
    //       neither of these means white

    // see: https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver/observe#examples
    // identify an element to observe
    const elementToObserve = document.querySelector(".book");

    // create a new instance of `MutationObserver` named `observer`,
    // passing it a callback function
    const observer = new MutationObserver(function() {

      // img elements with src attribute that end in '.svg'
      const selImageSvg = 'img[src$=".svg"]';

      // span elements used for source-code highlighting
      const selCodeHighlight = 'code.sourceCode > span > span:not(.bu):not(.im)';

      // create a callback function for an element to change its style.filter
      const setFilter = (value) => {
        return (element) => element.style.filter = value;
      }

      if (elementToObserve.classList.contains('color-theme-1')) {
        // console.log('i am sepia');

        // sepia images
        document.querySelectorAll(selImageSvg).forEach(setFilter('sepia(100%'));

        // do nothing to highlighting
        document.querySelectorAll(selCodeHighlight).forEach(setFilter(null));

     } else if (elementToObserve.classList.contains('color-theme-2')) {
        // console.log('i am night');

        // invert images
        document.querySelectorAll(selImageSvg).forEach(setFilter('invert(100%)'));

        // invert highlighting
        document.querySelectorAll(selCodeHighlight).forEach(setFilter('invert(100%)'));

      } else {
        // console.log('i am white');

        // do nothing to images
        document.querySelectorAll(selImageSvg).forEach(setFilter(null));

        // do nothing to highlighting
        document.querySelectorAll(selCodeHighlight).forEach(setFilter(null));
      }

    });

    // call `observe()` on that MutationObserver instance,
    // passing it the element to observe, and the options object
    observer.observe(elementToObserve, {attributeFilter: ['class']});

    // touch class to initiate observe event
    elementToObserve.classList = elementToObserve.classList;

  });
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Data-Science Reactivity: Three Ways</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="other-resources.html"><a href="other-resources.html"><i class="fa fa-check"></i>Other resources</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="shiny.html"><a href="shiny.html"><i class="fa fa-check"></i><b>1</b> Shiny</a>
<ul>
<li class="chapter" data-level="1.1" data-path="principles.html"><a href="principles.html"><i class="fa fa-check"></i><b>1.1</b> Principles</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="principles.html"><a href="principles.html#pure-functions-vs.-side-effects"><i class="fa fa-check"></i><b>1.1.1</b> Pure functions vs. side effects</a></li>
<li class="chapter" data-level="1.1.2" data-path="principles.html"><a href="principles.html#reactives-vs.-observers"><i class="fa fa-check"></i><b>1.1.2</b> Reactives vs. observers</a></li>
<li class="chapter" data-level="1.1.3" data-path="principles.html"><a href="principles.html#using-tidyverse-functions"><i class="fa fa-check"></i><b>1.1.3</b> Using tidyverse functions</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="demonstration-app.html"><a href="demonstration-app.html"><i class="fa fa-check"></i><b>1.2</b> Demonstration App</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="demonstration-app.html"><a href="demonstration-app.html#description"><i class="fa fa-check"></i><b>1.2.1</b> Description</a></li>
<li class="chapter" data-level="1.2.2" data-path="demonstration-app.html"><a href="demonstration-app.html#prelims"><i class="fa fa-check"></i><b>1.2.2</b> Prelims</a></li>
<li class="chapter" data-level="1.2.3" data-path="demonstration-app.html"><a href="demonstration-app.html#helper-functions"><i class="fa fa-check"></i><b>1.2.3</b> Helper functions</a></li>
<li class="chapter" data-level="1.2.4" data-path="demonstration-app.html"><a href="demonstration-app.html#ui"><i class="fa fa-check"></i><b>1.2.4</b> UI</a></li>
<li class="chapter" data-level="1.2.5" data-path="demonstration-app.html"><a href="demonstration-app.html#server-function"><i class="fa fa-check"></i><b>1.2.5</b> Server function</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="dash.html"><a href="dash.html"><i class="fa fa-check"></i><b>2</b> Dash</a>
<ul>
<li class="chapter" data-level="2.1" data-path="principles-1.html"><a href="principles-1.html"><i class="fa fa-check"></i><b>2.1</b> Principles</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="principles-1.html"><a href="principles-1.html#everything-that-exists-is-a-component"><i class="fa fa-check"></i><b>2.1.1</b> Everything that exists is a component</a></li>
<li class="chapter" data-level="2.1.2" data-path="principles-1.html"><a href="principles-1.html#everything-that-happens-is-a-callback"><i class="fa fa-check"></i><b>2.1.2</b> Everything that happens is a callback</a></li>
<li class="chapter" data-level="2.1.3" data-path="principles-1.html"><a href="principles-1.html#server-cannot-store-state"><i class="fa fa-check"></i><b>2.1.3</b> Server cannot store state</a></li>
<li class="chapter" data-level="2.1.4" data-path="principles-1.html"><a href="principles-1.html#use-json-or-base64"><i class="fa fa-check"></i><b>2.1.4</b> Use JSON or base64</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="demonstration-app-1.html"><a href="demonstration-app-1.html"><i class="fa fa-check"></i><b>2.2</b> Demonstration app</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="demonstration-app-1.html"><a href="demonstration-app-1.html#description-1"><i class="fa fa-check"></i><b>2.2.1</b> Description</a></li>
<li class="chapter" data-level="2.2.2" data-path="demonstration-app-1.html"><a href="demonstration-app-1.html#prelims-1"><i class="fa fa-check"></i><b>2.2.2</b> Prelims</a></li>
<li class="chapter" data-level="2.2.3" data-path="demonstration-app-1.html"><a href="demonstration-app-1.html#helper-functions-1"><i class="fa fa-check"></i><b>2.2.3</b> Helper functions</a></li>
<li class="chapter" data-level="2.2.4" data-path="demonstration-app-1.html"><a href="demonstration-app-1.html#compmonent-layout"><i class="fa fa-check"></i><b>2.2.4</b> Compmonent layout</a></li>
<li class="chapter" data-level="2.2.5" data-path="demonstration-app-1.html"><a href="demonstration-app-1.html#callback-functions"><i class="fa fa-check"></i><b>2.2.5</b> Callback functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="observable.html"><a href="observable.html"><i class="fa fa-check"></i><b>3</b> Observable</a>
<ul>
<li class="chapter" data-level="3.1" data-path="principles-2.html"><a href="principles-2.html"><i class="fa fa-check"></i><b>3.1</b> Principles</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="principles-2.html"><a href="principles-2.html#hosted-service-runs-in-browser"><i class="fa fa-check"></i><b>3.1.1</b> Hosted service runs in browser</a></li>
<li class="chapter" data-level="3.1.2" data-path="principles-2.html"><a href="principles-2.html#reactivity-baked-in"><i class="fa fa-check"></i><b>3.1.2</b> Reactivity baked in</a></li>
<li class="chapter" data-level="3.1.3" data-path="principles-2.html"><a href="principles-2.html#javascript"><i class="fa fa-check"></i><b>3.1.3</b> JavaScript</a></li>
<li class="chapter" data-level="3.1.4" data-path="principles-2.html"><a href="principles-2.html#tidyverse-thinking-helps"><i class="fa fa-check"></i><b>3.1.4</b> Tidyverse thinking helps</a></li>
<li class="chapter" data-level="3.1.5" data-path="principles-2.html"><a href="principles-2.html#viewof-is-a-useful-construct"><i class="fa fa-check"></i><b>3.1.5</b> <code>viewof</code> is a useful construct</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="demonstration-app-2.html"><a href="demonstration-app-2.html"><i class="fa fa-check"></i><b>3.2</b> Demonstration app</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="demonstration-app-2.html"><a href="demonstration-app-2.html#appendix"><i class="fa fa-check"></i><b>3.2.1</b> Appendix</a></li>
<li class="chapter" data-level="3.2.2" data-path="demonstration-app-2.html"><a href="demonstration-app-2.html#workshop"><i class="fa fa-check"></i><b>3.2.2</b> Workshop</a></li>
<li class="chapter" data-level="3.2.3" data-path="demonstration-app-2.html"><a href="demonstration-app-2.html#showcase"><i class="fa fa-check"></i><b>3.2.3</b> Showcase</a></li>
</ul></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="stray-thoughts.html"><a href="stray-thoughts.html"><i class="fa fa-check"></i><b>A</b> Stray Thoughts</a></li>
<li class="chapter" data-level="B" data-path="field-guide-to-python.html"><a href="field-guide-to-python.html"><i class="fa fa-check"></i><b>B</b> Field Guide to Python</a>
<ul>
<li class="chapter" data-level="B.1" data-path="python-installation.html"><a href="python-installation.html"><i class="fa fa-check"></i><b>B.1</b> Python installation</a></li>
<li class="chapter" data-level="B.2" data-path="project-management.html"><a href="project-management.html"><i class="fa fa-check"></i><b>B.2</b> Project management</a>
<ul>
<li class="chapter" data-level="B.2.1" data-path="project-management.html"><a href="project-management.html#git"><i class="fa fa-check"></i><b>B.2.1</b> Git</a></li>
<li class="chapter" data-level="B.2.2" data-path="project-management.html"><a href="project-management.html#virtual-environment"><i class="fa fa-check"></i><b>B.2.2</b> Virtual Environment</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="C" data-path="deployment.html"><a href="deployment.html"><i class="fa fa-check"></i><b>C</b> Deployment</a>
<ul>
<li class="chapter" data-level="C.1" data-path="shiny-1.html"><a href="shiny-1.html"><i class="fa fa-check"></i><b>C.1</b> Shiny</a></li>
<li class="chapter" data-level="C.2" data-path="dash-1.html"><a href="dash-1.html"><i class="fa fa-check"></i><b>C.2</b> Dash</a></li>
<li class="chapter" data-level="C.3" data-path="observable-1.html"><a href="observable-1.html"><i class="fa fa-check"></i><b>C.3</b> Observable</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data-Science Reactivity: Three Ways</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="demonstration-app-2" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Demonstration app</h2>
<p>Here’s the link to the now-familar <a href="https://observablehq.com/@ijlyttle/aggregate-local">aggregator app</a>.</p>
<p>In Observable, there is not a clear distiction between an input and an output.
I find it helpful to think of <em>everything</em> in Observable as a reactive varriable.</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-33"></span>
<img src="images/observable-aggregate-local.svg" alt="Reactivity diagram"  />
<p class="caption">
Figure 3.2: Reactivity diagram
</p>
</div>
<p>As noted above, and as we’ll see in greater detail, we use the <code>viewof</code> interface often to display things to the screen, while keeping track of the value.
This is such an important concept that I indicate which of the variables in the app use the <code>viewof</code> interface.</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-34"></span>
<img src="images/observable-legend.svg" alt="Legend"  />
<p class="caption">
Figure 3.3: Legend
</p>
</div>
<p>Observable does not require variables to be defined in any particular order.
As a result, I have adapted a style (I’ve see others do it, too) where a notebook has three sections:</p>
<ul>
<li>Showcase: mostly graphical and/or interactive, aimed at a general audience.</li>
<li>Workshop: contains supporting code and explanations, aimed at a more-technical audience.</li>
<li>Appendix: import objects and offer functions for other notebooks to import.</li>
</ul>
<p>In this chapter, we’ll go over this “backwards”.</p>
<div id="appendix" class="section level3" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Appendix</h3>
<p>Here’s where wee import stuff into our notebook.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb72-1"><a href="demonstration-app-2.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { aq<span class="op">,</span> op } <span class="im">from</span> <span class="st">&quot;@uwdata/arquero&quot;</span></span></code></pre></div>
<p>Here, we’re importing objects from another notebook, in this case, a notebook that features the arquero library.</p>
<p>Arquero contains functionality along the lines of dplyr and tidyr.</p>
<p>Also tidyjs does much the same thing - it’s a matter of preference which you use.
Tidyjs is designed to be familiar to tidyverse users.</p>
<p>I use a lot of Vega-Lite; arquero is made by the same group.
Also, <a href="https://observablehq.com/@uwdata/arquero-and-apache-arrow">arquero is designed to work with Apache Arrow</a>.</p>
</div>
<div id="workshop" class="section level3" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Workshop</h3>
<p>Our first step is to import our data into the notebook.
One way to do that is to use a file attachment, one of the few times we interact with Observable not using a cell.</p>
<p>If we have the result of a multi-step process that we want to put into a variable, we can make put the code in some curly braces, then <code>return</code> the result:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb73-1"><a href="demonstration-app-2.html#cb73-1" aria-hidden="true" tabindex="-1"></a>inp <span class="op">=</span> {</span>
<span id="cb73-2"><a href="demonstration-app-2.html#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> text <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(<span class="st">&quot;penguins.csv&quot;</span>)<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb73-3"><a href="demonstration-app-2.html#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> textRemoveNA <span class="op">=</span> text<span class="op">.</span><span class="fu">replaceAll</span>(<span class="ss">/,NA/gi</span><span class="op">,</span> <span class="st">&quot;,&quot;</span>)<span class="op">;</span></span>
<span id="cb73-4"><a href="demonstration-app-2.html#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="demonstration-app-2.html#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> aq<span class="op">.</span><span class="fu">fromCSV</span>(textRemoveNA)<span class="op">;</span></span>
<span id="cb73-6"><a href="demonstration-app-2.html#cb73-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here, we see that we import the text, then remove instances of <code>"NA"</code>.
This puts the text in a format that can be parsed by <code>arquero.fromCSV()</code>, which returns an arquero <code>Table</code>.</p>
<p>The notebook is designed such that we can bind <code>inp</code> to any arquero <code>Table</code>, not just <code>penguins</code>, and it should work equally well.</p>
<p>Next, we need a function to help us determine which columns can be used for grouping, and which for aggregation.</p>
<p>This is a personal habit since trying to be more aware of functional programming, but whenever I make a function in Observable, I like to make the signature as prominent as possible.
I use a variation of <a href="https://drboolean.gitbooks.io/mostly-adequate-guide-old/content/ch7.html">Hindley-Miller notation</a>, which is a fancy way of saying that I want to keep track of the types for the parameters and return-value:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb74-1"><a href="demonstration-app-2.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* (Table, (* -&gt; Boolean)) -&gt; [String]</span></span>
<span id="cb74-2"><a href="demonstration-app-2.html#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb74-3"><a href="demonstration-app-2.html#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Given an arquero table and a predicate-function,</span></span>
<span id="cb74-4"><a href="demonstration-app-2.html#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * return an array of strings corresponding to names of</span></span>
<span id="cb74-5"><a href="demonstration-app-2.html#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * columns that satisfy the predicate.</span></span>
<span id="cb74-6"><a href="demonstration-app-2.html#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb74-7"><a href="demonstration-app-2.html#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * This can be useful to identify which columns are strings</span></span>
<span id="cb74-8"><a href="demonstration-app-2.html#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * or numbers, etc.</span></span>
<span id="cb74-9"><a href="demonstration-app-2.html#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb74-10"><a href="demonstration-app-2.html#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co"> * Note that null values are removed before the predicate</span></span>
<span id="cb74-11"><a href="demonstration-app-2.html#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="co"> * is applied.</span></span>
<span id="cb74-12"><a href="demonstration-app-2.html#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb74-13"><a href="demonstration-app-2.html#cb74-13" aria-hidden="true" tabindex="-1"></a>columnNamesPredicate <span class="op">=</span> <span class="kw">function</span> (data<span class="op">,</span> predicate) {</span>
<span id="cb74-14"><a href="demonstration-app-2.html#cb74-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> colNames <span class="op">=</span> data<span class="op">.</span><span class="fu">columnNames</span>()<span class="op">;</span></span>
<span id="cb74-15"><a href="demonstration-app-2.html#cb74-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> keep <span class="op">=</span> colNames<span class="op">.</span><span class="fu">filter</span>((x) <span class="kw">=&gt;</span></span>
<span id="cb74-16"><a href="demonstration-app-2.html#cb74-16" aria-hidden="true" tabindex="-1"></a>    data</span>
<span id="cb74-17"><a href="demonstration-app-2.html#cb74-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">array</span>(x)</span>
<span id="cb74-18"><a href="demonstration-app-2.html#cb74-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>((x) <span class="kw">=&gt;</span> <span class="op">!</span>_<span class="op">.</span><span class="fu">isNull</span>(x))</span>
<span id="cb74-19"><a href="demonstration-app-2.html#cb74-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">every</span>(predicate)</span>
<span id="cb74-20"><a href="demonstration-app-2.html#cb74-20" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb74-21"><a href="demonstration-app-2.html#cb74-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> keep<span class="op">;</span></span>
<span id="cb74-22"><a href="demonstration-app-2.html#cb74-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that the second parameter, <code>predicate</code>, is a function that takes any type of value and returns a boolean.
If I wanted to return the names of string-columns, I would supply the Lodash function <code>_.isString</code>.</p>
<p>An arquero table is a object of arrays, just like R’s data frame is a list of (most-often) vectors; it’s a column-based approach.</p>
<p>First, we get an array of <code>colNames</code>.
Then we filter this array using another predicate function:</p>
<ul>
<li><code>data.array(x)</code>: given the array of values in the column named <code>x</code>,</li>
<li><code>.filter((x) =&gt; !_.isNull(x))</code>: keep only those values that are not null,</li>
<li><code>.every(predicate)</code>: return <code>true</code> if every value in the array satisfies the <code>predicate</code> function we supplies.</li>
</ul>
<p>We return only those column names where our predicate function returns <code>true</code>.</p>
<p>We also need a function to build an arquero query-object based on our specification.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb75-1"><a href="demonstration-app-2.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* ([String], [String], String) -&gt; Object</span></span>
<span id="cb75-2"><a href="demonstration-app-2.html#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb75-3"><a href="demonstration-app-2.html#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Given an array of column names for grouping, an array of</span></span>
<span id="cb75-4"><a href="demonstration-app-2.html#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * column names for aggregations, and the name of an aggregation</span></span>
<span id="cb75-5"><a href="demonstration-app-2.html#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * function, return an object used to construct an Arquero query.</span></span>
<span id="cb75-6"><a href="demonstration-app-2.html#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb75-7"><a href="demonstration-app-2.html#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * The query will group by `cols_group`, then rollup (aggregate)</span></span>
<span id="cb75-8"><a href="demonstration-app-2.html#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * over `cols_agg`, using the function identified using `func_agg`.</span></span>
<span id="cb75-9"><a href="demonstration-app-2.html#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb75-10"><a href="demonstration-app-2.html#cb75-10" aria-hidden="true" tabindex="-1"></a>buildQueryObject <span class="op">=</span> <span class="kw">function</span> (cols_group<span class="op">,</span> cols_agg<span class="op">,</span> func_agg) {</span>
<span id="cb75-11"><a href="demonstration-app-2.html#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> values <span class="op">=</span> cols_agg<span class="op">.</span><span class="fu">reduce</span>(</span>
<span id="cb75-12"><a href="demonstration-app-2.html#cb75-12" aria-hidden="true" tabindex="-1"></a>    (acc<span class="op">,</span> val) <span class="kw">=&gt;</span> ({</span>
<span id="cb75-13"><a href="demonstration-app-2.html#cb75-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>acc<span class="op">,</span></span>
<span id="cb75-14"><a href="demonstration-app-2.html#cb75-14" aria-hidden="true" tabindex="-1"></a>      [val]<span class="op">:</span> { <span class="dt">expr</span><span class="op">:</span> <span class="vs">`(d) =&gt; op.</span><span class="sc">${</span>func_agg<span class="sc">}</span><span class="vs">(d[&quot;</span><span class="sc">${</span>val<span class="sc">}</span><span class="vs">&quot;])`</span><span class="op">,</span> <span class="dt">func</span><span class="op">:</span> <span class="kw">true</span> }</span>
<span id="cb75-15"><a href="demonstration-app-2.html#cb75-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb75-16"><a href="demonstration-app-2.html#cb75-16" aria-hidden="true" tabindex="-1"></a>    {}</span>
<span id="cb75-17"><a href="demonstration-app-2.html#cb75-17" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb75-18"><a href="demonstration-app-2.html#cb75-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-19"><a href="demonstration-app-2.html#cb75-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> queryObject <span class="op">=</span> {</span>
<span id="cb75-20"><a href="demonstration-app-2.html#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">verbs</span><span class="op">:</span> [</span>
<span id="cb75-21"><a href="demonstration-app-2.html#cb75-21" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">verb</span><span class="op">:</span> <span class="st">&quot;groupby&quot;</span><span class="op">,</span> <span class="dt">keys</span><span class="op">:</span> cols_group }<span class="op">,</span></span>
<span id="cb75-22"><a href="demonstration-app-2.html#cb75-22" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">verb</span><span class="op">:</span> <span class="st">&quot;rollup&quot;</span><span class="op">,</span> <span class="dt">values</span><span class="op">:</span> values }</span>
<span id="cb75-23"><a href="demonstration-app-2.html#cb75-23" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb75-24"><a href="demonstration-app-2.html#cb75-24" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb75-25"><a href="demonstration-app-2.html#cb75-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-26"><a href="demonstration-app-2.html#cb75-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> queryObject<span class="op">;</span></span>
<span id="cb75-27"><a href="demonstration-app-2.html#cb75-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>There are two operations in this query:</p>
<ul>
<li><code>"groupby"</code>, where we use the <code>cols_group</code>.</li>
<li><code>"rollup"</code>, where we build another object to specify the aggregation.</li>
</ul>
<p>If our aggregation function is <code>min</code>, and our aggregtion columns are <code>["bill_length_mm", "bill_depth_mm"]</code>, then the rollup specification should be:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb76-1"><a href="demonstration-app-2.html#cb76-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb76-2"><a href="demonstration-app-2.html#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bill_length_mm</span><span class="op">:</span> {<span class="dt">expr</span><span class="op">:</span> <span class="vs">`(d) =&gt; op.min(d[&quot;bill_length_mm&quot;])`</span><span class="op">,</span> <span class="dt">func</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">,</span></span>
<span id="cb76-3"><a href="demonstration-app-2.html#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bill_depth_mm</span><span class="op">:</span> {<span class="dt">expr</span><span class="op">:</span> <span class="vs">`(d) =&gt; op.min(d[&quot;bill_depth_mm&quot;])`</span><span class="op">,</span> <span class="dt">func</span><span class="op">:</span> <span class="kw">true</span> }</span>
<span id="cb76-4"><a href="demonstration-app-2.html#cb76-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In arquero, we supply an object to describe rollup (aggregation) operations:
- The object’s names are column names in the resulting table.
- The object’s values are expressed as functions.
- the function takes the “data frame” as an argument; you can subset the data frame by column-name.
- for security reasons, by default, arquero makes only certain operations available by default; these operations are contained in the <code>op</code> object.</p>
<p>Thus, we build the rollup object by using a <code>reduce()</code> function on the <code>cols_group</code> array:</p>
<ul>
<li>The accumulator is initalized with an empty object, <code>{}</code>.</li>
<li>For each value (<code>val</code>) in the <code>cols_group</code> array, given the accumulator <code>acc</code>:
<ul>
<li>return a new object containing <code>acc</code> and a new named element.</li>
</ul></li>
</ul>
<p>It can be a lot to absorb JavaScript, functional programming, and the peculiarities of arquero <em>all at once</em>.
Keep in mind that you can apply the functional programming you learned using purrr, and your knowledge of how <code>group_by()</code> and <code>summarise()</code> work in dplyr.</p>
<p>Here’s the equivalent in R, using purrr and rlang:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="demonstration-app-2.html#cb77-1" aria-hidden="true" tabindex="-1"></a>reducer <span class="ot">&lt;-</span> <span class="cf">function</span>(acc, val, func) {</span>
<span id="cb77-2"><a href="demonstration-app-2.html#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="demonstration-app-2.html#cb77-3" aria-hidden="true" tabindex="-1"></a>  mapped <span class="ot">&lt;-</span> </span>
<span id="cb77-4"><a href="demonstration-app-2.html#cb77-4" aria-hidden="true" tabindex="-1"></a>    rlang<span class="sc">::</span><span class="fu">list2</span>(</span>
<span id="cb77-5"><a href="demonstration-app-2.html#cb77-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;{val}&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">list</span>(</span>
<span id="cb77-6"><a href="demonstration-app-2.html#cb77-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">expr =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">&#39;(d) =&gt; op.{func}(d[&quot;{val}&quot;])&#39;</span>), </span>
<span id="cb77-7"><a href="demonstration-app-2.html#cb77-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">func =</span> <span class="cn">TRUE</span></span>
<span id="cb77-8"><a href="demonstration-app-2.html#cb77-8" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb77-9"><a href="demonstration-app-2.html#cb77-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-10"><a href="demonstration-app-2.html#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="demonstration-app-2.html#cb77-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(acc, mapped)</span>
<span id="cb77-12"><a href="demonstration-app-2.html#cb77-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-13"><a href="demonstration-app-2.html#cb77-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-14"><a href="demonstration-app-2.html#cb77-14" aria-hidden="true" tabindex="-1"></a>values <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">reduce</span>(cols_agg, reducer, <span class="at">func =</span> func_agg, <span class="at">.init =</span> <span class="fu">list</span>())</span></code></pre></div>
<p>This gets a little heavy because we have to use <code>rlang::list2()</code> to interpolate the names: <code>"{val}" :=</code>.</p>
<p>We don’t have the same check here to validate the aggregation function.
Security considerations are a little bit different when using Observable.
Because Observable runs this app entirely in the user’s browser, there is no server component.
Thus, the user is free to run whatever code they like - it’s a bit like an IDE in that respect.</p>
<p>There are some considerations around protecting secrets, but these do not apply to this app.</p>
</div>
<div id="showcase" class="section level3" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Showcase</h3>
<p>Here’s where we show what the notebook can do.
First, we display the <code>inp</code> table, using Observable’s built-in <code>Inputs.Table()</code>:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb78-1"><a href="demonstration-app-2.html#cb78-1" aria-hidden="true" tabindex="-1"></a>viewof table_inp <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">table</span>(inp)</span></code></pre></div>
<p><code>table_inp</code> has a value (we can select rows), but we don’t use it.</p>
<p>Next, we have an input for the grouping columns.
We are using the <code>columnNamesPredicate()</code> function using Lodash’s <code>_.isString</code>:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb79-1"><a href="demonstration-app-2.html#cb79-1" aria-hidden="true" tabindex="-1"></a>viewof cols_group <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(<span class="fu">columnNamesPredicate</span>(inp<span class="op">,</span> _<span class="op">.</span><span class="at">isString</span>)<span class="op">,</span> {</span>
<span id="cb79-2"><a href="demonstration-app-2.html#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">&quot;Grouping columns&quot;</span><span class="op">,</span></span>
<span id="cb79-3"><a href="demonstration-app-2.html#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">multiple</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb79-4"><a href="demonstration-app-2.html#cb79-4" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>The input for <code>cols_agg</code> is almost identical; there, we use <code>_.isNumber</code> as a predicate.</p>
<p>The input for <code>func_agg</code> is fairly straightforward:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb80-1"><a href="demonstration-app-2.html#cb80-1" aria-hidden="true" tabindex="-1"></a>viewof func_agg <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>([<span class="st">&quot;mean&quot;</span><span class="op">,</span> <span class="st">&quot;min&quot;</span><span class="op">,</span> <span class="st">&quot;max&quot;</span>]<span class="op">,</span> {</span>
<span id="cb80-2"><a href="demonstration-app-2.html#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">&quot;Aggregation function&quot;</span><span class="op">,</span></span>
<span id="cb80-3"><a href="demonstration-app-2.html#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">multiple</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb80-4"><a href="demonstration-app-2.html#cb80-4" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>For each of these inputs: <code>cols_group</code>, <code>cols_agg</code>, and <code>func_agg</code>, the value is the selection.</p>
<p>The button is less straightforward; we view is the button, but the value is the aggregated table.
The two are joined by a <code>reduce</code> option, a function that is run whenever the button is clicked.</p>
<p>In our case, the reduce function runs the query on the <code>inp</code> table, and returns the aggregated table.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb81-1"><a href="demonstration-app-2.html#cb81-1" aria-hidden="true" tabindex="-1"></a>viewof agg <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">button</span>(<span class="st">&quot;Submit&quot;</span><span class="op">,</span> {</span>
<span id="cb81-2"><a href="demonstration-app-2.html#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> aq<span class="op">.</span><span class="fu">table</span>()<span class="op">,</span></span>
<span id="cb81-3"><a href="demonstration-app-2.html#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reduce</span><span class="op">:</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb81-4"><a href="demonstration-app-2.html#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> aq</span>
<span id="cb81-5"><a href="demonstration-app-2.html#cb81-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">queryFrom</span>(<span class="fu">buildQueryObject</span>(cols_group<span class="op">,</span> cols_agg<span class="op">,</span> func_agg))</span>
<span id="cb81-6"><a href="demonstration-app-2.html#cb81-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">evaluate</span>(inp)<span class="op">;</span></span>
<span id="cb81-7"><a href="demonstration-app-2.html#cb81-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-8"><a href="demonstration-app-2.html#cb81-8" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Finally, we display the <code>agg</code> table:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb82-1"><a href="demonstration-app-2.html#cb82-1" aria-hidden="true" tabindex="-1"></a>viewof table_agg <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">table</span>(agg)</span></code></pre></div>

</div>
</div>
<!-- </div> -->



            </section>

          </div>
        </div>
      </div>
<a href="principles-2.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="stray-thoughts.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub", "_main.mobi"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "none"
}
});
});
</script>

</body>

</html>
